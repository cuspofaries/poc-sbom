# =============================================================================
# Reusable SBOM Pipeline
# =============================================================================
# Verifies image signature, generates SBOM, attests it, scans, and enforces
# policies. Expects the image to already be built and signed (by poc-build-sign).
#
# Usage (in caller's workflow):
#
#   jobs:
#     build:
#       uses: cuspofaries/poc-build-sign/.github/workflows/build-sign-reusable.yml@main
#       with:
#         context: ./app
#         image-name: my-app
#       secrets:
#         REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
#     sbom:
#       needs: build
#       uses: cuspofaries/poc-sbom/.github/workflows/sbom-reusable.yml@main
#       with:
#         image: ${{ needs.build.outputs.image }}
#         image-name: my-app
#       secrets:
#         DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
#         REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
# =============================================================================

name: SBOM Pipeline (Reusable)

on:
  workflow_call:
    inputs:
      image:
        description: "Full image reference (digest preferred, e.g. ghcr.io/org/app@sha256:...)"
        required: true
        type: string
      image-name:
        description: "Project name for Dependency-Track"
        required: true
        type: string
      dtrack-hostname:
        description: "Dependency-Track server hostname (skip upload if empty)"
        required: false
        type: string
        default: ""
      cosign-oidc-issuer:
        description: "Expected OIDC issuer for signature verification"
        required: false
        type: string
        default: "https://token.actions.githubusercontent.com"
      cosign-identity-regexp:
        description: "Regexp matching the expected signer identity"
        required: false
        type: string
        default: "github.com/cuspofaries/"
    secrets:
      DTRACK_API_KEY:
        description: "Dependency-Track API key"
        required: false
      REGISTRY_TOKEN:
        description: "Token to pull image from registry (e.g. GITHUB_TOKEN)"
        required: false

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  sbom:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout SBOM toolchain
        uses: actions/checkout@v4
        with:
          repository: cuspofaries/poc-sbom
          ref: main

      - name: Checkout consumer repo (for custom policies)
        uses: actions/checkout@v4
        with:
          path: consumer-repo

      - name: Install Task
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin

      - name: Install SBOM tools
        run: sudo task install

      - name: Login to GHCR
        run: echo "$REGISTRY_TOKEN" | docker login ghcr.io -u _ --password-stdin
        env:
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}

      - name: Verify image signature
        run: |
          echo "Verifying image signature: ${{ inputs.image }}"
          cosign verify \
            --certificate-oidc-issuer "${{ inputs.cosign-oidc-issuer }}" \
            --certificate-identity-regexp "${{ inputs.cosign-identity-regexp }}" \
            "${{ inputs.image }}"
          echo "Image signature verified"

      - name: Pull image
        run: docker pull ${{ inputs.image }}

      - name: Generate image SBOM
        run: |
          task sbom:generate:image \
            IMAGE=${{ inputs.image }}

      - name: Attest SBOM to image
        run: |
          task sbom:sign \
            IMAGE=${{ inputs.image }}

      - name: Scan vulnerabilities
        run: task sbom:scan

      - name: Policy check (OPA)
        run: |
          if [ -d "consumer-repo/policies" ]; then
            echo "Custom policies found in consumer repo"
            task sbom:policy EXTRA_POLICIES=consumer-repo/policies
          else
            task sbom:policy
          fi

      - name: Push SBOM to Dependency-Track
        if: ${{ inputs.dtrack-hostname != '' }}
        uses: DependencyTrack/gh-upload-sbom@v3
        with:
          serverHostname: ${{ inputs.dtrack-hostname }}
          apiKey: ${{ secrets.DTRACK_API_KEY }}
          projectName: ${{ inputs.image-name }}
          projectVersion: ${{ github.sha }}
          bomFilename: output/sbom/image/sbom-image-trivy.json
          autoCreate: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-outputs
          path: output/
          retention-days: 30
